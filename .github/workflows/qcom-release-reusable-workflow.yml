name: Release Promotion Workflow
description: |
  This reusable workflow is called by a user to create a release of the package

on:
  workflow_call:
    inputs:
      qcom-build-utils-ref:
        description: The ref name that was used to invoke this reusable workflow
        type: string
        required: true

      distro-codename:
        description: The distribution codename to build for. Ex noble, jammy, etc
        type: string
        default: noble

    secrets:
      TOKEN:
        required: true

permissions:
  contents: read
  security-events: write

jobs:
  pkg-release:

    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:

      - name: Install devscripts
        run: sudo apt update && sudo apt install -y devscripts

      - name: Checkout Packaging Repo
        uses: actions/checkout@v4
        with:
          clean: false
          token: ${{secrets.TOKEN}}
          path: ./package-repo
          fetch-depth: 0
          fetch-tags: true

      - name: Changelog suite name change
        run: |
          cd ./package-repo

          git checkout debian/latest

          cat debian/changelog

          # Check if the latest changelog entry suite is UNRELEASED
          if ! head -1 debian/changelog | grep -q 'UNRELEASED'; then
            echo "Error: The suite in the latest changelog entry is not UNRELEASED." \
                 "The release process expects the latest entry to be UNRELEASED at any point except in the commit (this one) that represents the release"
            exit 1
          fi

          #Update the changelog timestamp
          dch --release --distribution=unstable "Release"

          cat debian/changelog

      - name: Commit changelog suite change
        run: |
          cd ./package-repo

          git config user.name "${{vars.DEB_PKG_BOT_CI_NAME}}"
          git config user.email "${{vars.DEB_PKG_BOT_CI_EMAIL}}"

          export DEBFULLNAME="${{vars.DEB_PKG_BOT_CI_NAME}}"
          export DEBEMAIL="${{vars.DEB_PKG_BOT_CI_EMAIL}}"

          version=$(dpkg-parsechangelog --show-field Version)
          
          git commit -a -m "Release version ${version}"

          git tag debian/${version}

          # bump Debian revision (last hyphen-separated field), e.g. 1.0.0-1 -> 1.0.0-2
          if [[ "$version" != *-* ]]; then
            echo "Error: version '$version' has no debian revision part" >&2
            exit 1
          fi

          upstream="${version%-*}"
          rev="${version##*-}"

          if ! [[ "$rev" =~ ^[0-9]+$ ]]; then
            echo "Error: debian revision '$rev' is not numeric" >&2
            exit 1
          fi

          rev=$((rev + 1))
          newversion="${upstream}-${rev}"
          echo "Bumped version -> ${newversion}"
          dch --newversion=${newversion} --distribution=UNRELEASED --controlmaint "Initial commit"

          git commit -a -m "Initial commit of new version ${newversion}"
          git push origin debian/latest
          git push origin debian/${version} 
