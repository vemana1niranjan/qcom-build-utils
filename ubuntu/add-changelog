#!/bin/sh
# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
#
# SPDX-License-Identifier: BSD-3-Clause-Clear

# Function to display help message
show_help() {
    echo "Usage: $0 --name NAME --email EMAIL --message MESSAGE --urgency URGENCY --version VERSION"
    echo ""
    echo "Parameters:"
    echo "  --name       Maintainer's full name"
    echo "  --email      Maintainer's email address"
    echo "  --message    Changelog message"
    echo "  --urgency    Urgency level (low, medium, high, critical, emergency)"
    echo "  --version    New version number (e.g., 1.2.3-1)"
    echo "  --help       Show this help message and exit"
}

# Check for --help
if [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Parse named arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --name) NAME="$2"; shift ;;
        --email) EMAIL="$2"; shift ;;
        --message) MESSAGE="$2"; shift ;;
        --urgency) URGENCY="$2"; shift ;;
        --version) VERSION="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; show_help; exit 1 ;;
    esac
    shift
done

# Check if debian/changelog exists
if [[ ! -f "debian/changelog" ]]; then
    echo "Error: debian/changelog not found in the current directory."
    exit 1
fi

# Check if all required parameters are provided
if [[ -z "$NAME" || -z "$EMAIL" || -z "$MESSAGE" || -z "$URGENCY" || -z "$VERSION" ]]; then
    echo "Error: Missing required parameters."
    show_help
    exit 1
fi

# Validate version format (a.b.c)
if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Version must be in the format a.b.c (e.g., 1.2.3)"
    exit 1
fi

# Validate email format and domain (qti.qualcomm.com or quicinc.com)
if [[ ! "$EMAIL" =~ ^[a-zA-Z0-9._%+-]+@(qti\.qualcomm\.com|quicinc\.com)$ ]]; then
    echo "Error: Email must be a valid address at qti.qualcomm.com or quicinc.com"
    exit 1
fi


# Validate urgency level
case "$URGENCY" in
    low|medium|high|critical|emergency)
        # valid
        ;;
    *)
        echo "Error: Urgency must be one of: low, medium, high, critical, emergency"
        exit 1
        ;;
esac

# Run dch with the provided parameters
DEBFULLNAME="$NAME" DEBEMAIL="$EMAIL" \
dch --newversion="$VERSION" -D noble --urgency="$URGENCY" "$MESSAGE"
